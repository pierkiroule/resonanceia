<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üåÄ IA R√©sonante</title>
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: system-ui, sans-serif;
      background: #0d0d0f;
      color: #e7e7ea;
      max-width: 780px;
      margin: 30px auto 80px;
      padding: 0 18px;
      line-height: 1.55;
    }
    h1, h2, h3 {
      color: #f4f4f6;
      margin-bottom: 0.2em;
    }
    p { margin: 0.2em 0 0.8em; }
    textarea, input, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #2a2a30;
      background: #16161b;
      color: #f0f0f5;
    }
    textarea { height: 120px; resize: vertical; }
    button {
      background: linear-gradient(120deg, #4a8bff, #7a6bff);
      border: none;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.01em;
      transition: transform 0.1s ease, opacity 0.2s ease;
    }
    button:hover { transform: translateY(-1px); opacity: 0.92; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    .panel {
      background: #121216;
      border: 1px solid #1e1e25;
      border-radius: 12px;
      padding: 14px 16px;
      margin-top: 16px;
      box-shadow: 0 10px 45px rgba(0,0,0,0.35);
    }
    .history { max-height: 360px; overflow-y: auto; padding-right: 6px; }
    .message { padding: 10px 12px; border-radius: 10px; margin-bottom: 10px; }
    .message.user { background: rgba(74, 139, 255, 0.08); border: 1px solid rgba(74,139,255,0.25); }
    .message.assistant { background: rgba(122, 107, 255, 0.1); border: 1px solid rgba(122,107,255,0.22); }
    .badge { display: inline-block; padding: 2px 7px; border-radius: 999px; background: #1e2635; color: #c8d1ff; font-size: 12px; margin-left: 6px; }
    .small { color: #9ca0b5; font-size: 13px; }
    pre {
      background: #101018;
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid #1c1c24;
      margin: 0;
    }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; align-items: center; }
    label { font-size: 13px; color: #9ca0b5; }
  </style>
</head>
<body>
  <header>
    <h1>üåÄ IA R√©sonante</h1>
    <p>Un espace pour d√©poser, √©couter, r√©sonner. Interface de d√©monstration reli√©e √† Nebius Studio.</p>
  </header>

  <section class="panel">
    <h3>Conversation</h3>
    <div class="history" id="history"></div>
    <div class="small" id="status">Pr√™t √† dialoguer (mod√®le Qwen/Qwen3-32B).</div>
    <textarea id="msg" placeholder="√âcris ce qui te traverse..."></textarea>
    <div class="row">
      <div>
        <label for="temperature">Temp√©rature</label>
        <input type="number" id="temperature" step="0.1" min="0" max="1" value="0.7" />
      </div>
      <div>
        <label for="top_p">Top P</label>
        <input type="number" id="top_p" step="0.05" min="0" max="1" value="0.9" />
      </div>
      <div>
        <label for="max_tokens">Max tokens</label>
        <input type="number" id="max_tokens" min="32" max="2000" value="256" />
      </div>
    </div>
    <button id="sendBtn">Envoyer</button>
    <button id="resetBtn" style="margin-top:8px; background:#272734;">R√©initialiser</button>
  </section>

  <section class="panel">
    <h3>Analyse r√©sonante</h3>
    <p class="small">Chaque message est aussi envoy√© √† l'API locale <code>/api/echo</code> pour extraire le pivot, le noyau et la p√©riph√©rie.</p>
    <pre id="echoPanel">En attente d'un premier message...</pre>
  </section>

  <section class="panel">
    <h3>Mod√®le Nebius</h3>
    <pre>
POST https://api.tokenfactory.nebius.com/v1/chat/completions
model: Qwen/Qwen3-32B
role: system -> psychologue clinicien bienveillant
    </pre>
  </section>

  <script>
    const historyEl = document.getElementById('history');
    const statusEl = document.getElementById('status');
    const echoPanel = document.getElementById('echoPanel');
    const sendBtn = document.getElementById('sendBtn');
    const resetBtn = document.getElementById('resetBtn');
    const messageInput = document.getElementById('msg');
    const temperatureInput = document.getElementById('temperature');
    const topPInput = document.getElementById('top_p');
    const maxTokensInput = document.getElementById('max_tokens');

    const conversation = [];

    function renderHistory() {
      historyEl.innerHTML = conversation.map(entry => {
        const roleLabel = entry.role === 'assistant' ? 'Assistant' : 'Vous';
        const roleClass = entry.role === 'assistant' ? 'assistant' : 'user';
        return `<div class="message ${roleClass}"><div class="small">${roleLabel}</div><div>${entry.content}</div></div>`;
      }).join('');
      historyEl.scrollTop = historyEl.scrollHeight;
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function resetConversation() {
      conversation.length = 0;
      renderHistory();
      echoPanel.textContent = 'En attente d\'un premier message...';
      setStatus('Pr√™t √† dialoguer (mod√®le Qwen/Qwen3-32B).');
    }

    async function updateEcho(message) {
      try {
        const res = await fetch('/api/echo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        if (!res.ok) {
          throw new Error('Erreur c√¥t√© √©cho');
        }

        const data = await res.json();
        echoPanel.textContent = `Pivot: ${data.pivot}\nNoyau: ${data.noyau.join(', ')}\nP√©riph√©rie: ${data.peripherie.join(', ')}\nM√©taphore: ${data.metaphor}\nQuestion: ${data.question}\n\n√âcho:\n${data.echo}`;
      } catch (error) {
        echoPanel.textContent = 'Analyse impossible: ' + error.message;
      }
    }

    async function sendMessage() {
      const content = messageInput.value.trim();
      if (!content) return;

      conversation.push({ role: 'user', content });
      renderHistory();
      messageInput.value = '';
      setStatus('‚è≥ Envoi au mod√®le Nebius...');
      sendBtn.disabled = true;

      const payload = {
        messages: conversation,
        temperature: Number(temperatureInput.value) || 0.7,
        top_p: Number(topPInput.value) || 0.9,
        max_tokens: Number(maxTokensInput.value) || 256
      };

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'R√©ponse invalide');
        }

        const data = await res.json();
        const reply = data.reply || '(pas de contenu)';
        conversation.push({ role: 'assistant', content: reply });
        renderHistory();
        setStatus(`‚úÖ R√©ponse du mod√®le ${data.model || 'Qwen/Qwen3-32B'} (messages envoy√©s: ${data.messagesSent || 'n/a'})`);
        updateEcho(content);
      } catch (error) {
        setStatus('‚ùå ' + error.message);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    resetBtn.addEventListener('click', resetConversation);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        sendMessage();
      }
    });

    renderHistory();
  </script>
</body>
</html>
